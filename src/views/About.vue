<template>
<section class="hero">
  <div class="hero-body">
    <div class="container">
      <h1 class="title is-2">
        å…³äº
      </h1>
      <h2 class="subtitle is-3">
        vtbs.moe
      </h2>
      <div class="columns">
        <div class="column">
          <h4 class="title is-4"><b><u><i>(æ–°)</i></u></b> DD@Browser</h4>
          <h4 class="subtitle is-4">åœ¨æµè§ˆå™¨DD!!</h4>
          <p>ç°åœ¨ <a href="https://greasyfork.org/scripts/403819-dd-browser/code/DD@Browser.user.js" target="_blank" rel="noopener noreferrer">å®‰è£…</a> DD@Browser, å¸®åŠ©vtbs.moeæŒç»­è¿è¡Œ<br>
            åˆ†å¸ƒå¼ä¿¡æ¯è·å–æµè§ˆå™¨æ’ä»¶DD@Browser<br>
            <br>
            GreasyFork: <a href="https://greasyfork.org/zh-CN/scripts/403819-dd-browser" target="_blank" rel="noopener noreferrer">https://greasyfork.org/zh-CN/scripts/403819-dd-browser</a><br>
            <br>
            <a href="https://github.com/dd-center/DDatBrowser/" target="_blank" rel="noopener noreferrer">github:dd-center/DDatBrowser</a><br>
            <a href="https://github.com/dd-center/DDatBrowser/" target="_blank" rel="noopener noreferrer"><img alt="GitHub stars" src="https://img.shields.io/github/stars/dd-center/DDatBrowser.svg?style=social"></a>
          </p>
          <hr>
          <h4 class="title is-4">submit.vtbs.moe</h4>
          <h4 class="subtitle is-4">åå•æŸ¥æ¼è¡¥ç¼º!</h4>
          <p>
            æäº¤æ–°çš„è™šæ‹Ÿä¸»æ’­ï¼Œä¿®æ”¹å·²æœ‰çš„è™šæ‹Ÿä¸»æ’­:<br>
            <a href="https://submit.vtbs.moe" target="_blank" rel="noopener noreferrer">https://submit.vtbs.moe</a><br>
            <br>
            <a href="https://github.com/dd-center/submit.vtbs.moe/" target="_blank" rel="noopener noreferrer">github:dd-center/submit.vtbs.moe</a><br>
            <a href="https://github.com/dd-center/submit.vtbs.moe/" target="_blank" rel="noopener noreferrer"><img alt="GitHub stars" src="https://img.shields.io/github/stars/dd-center/submit.vtbs.moe.svg?style=social"></a>
          </p>
          <hr>
          <h4 class="title is-4">DD@Electron</h4>
          <h4 class="subtitle is-4">åˆ†å¸ƒå¼DD!</h4>
          <p>ç°åœ¨ä¸‹è½½DD@Electron, å¸®åŠ©vtbs.moeæŒç»­è¿è¡Œ<br>
            å¼€æºè½¯ä»¶, æ— å¹¿å‘Šæ— ç—…æ¯’<br>
            åˆ†å¸ƒå¼ä¿¡æ¯è·å–DD@Electron<br>
            Windows: <a href="https://dd.center/api/latest/ddatelectron/windows" target="_blank" rel="noopener noreferrer">https://dd.center/api/latest/ddatelectron/windows</a><br>
            macOS: <a href="https://dd.center/api/latest/ddatelectron/mac" target="_blank" rel="noopener noreferrer">https://dd.center/api/latest/ddatelectron/mac</a><br>
            Github Release: <a href="https://github.com/dd-center/DDatElectron/releases/latest" target="_blank" rel="noopener noreferrer">https://github.com/dd-center/DDatElectron/releases/latest</a><br>
            <br>
            <a href="https://github.com/dd-center/ddatelectron/" target="_blank" rel="noopener noreferrer">github:dd-center/ddatelectron</a><br>
            <a href="https://github.com/dd-center/ddatelectron/" target="_blank" rel="noopener noreferrer"><img alt="GitHub stars" src="https://img.shields.io/github/stars/dd-center/ddatelectron.svg?style=social"></a>
          </p>
          <hr>
          <p> ğŸ‰ æŒ‰ç…§å…³æ³¨æ•°æ’åˆ—<br>
            ç›´æ’­åŠ¿ï¼šç›´æ’­ä¸­çš„æŒ‰ç…§äººæ°”æ’åˆ—ï¼Œé å‰ï¼Œå…¶ä»–æŒ‰ç…§èˆ°é˜Ÿæ’åˆ—<br>
            å®è§‚ç»æµï¼šbilibili è™šæ‹Ÿä¸–ç•Œå®è§‚èµ°åŠ¿<br>
            æ•°æ®æ¯ 5 åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡<br>
            ç›´æ’­åŠ¿çš„ç›´æ’­çŠ¶æ€å’Œäººæ°”æ¯ 15-30 ç§’æ›´æ–°ä¸€æ¬¡<br>
            å®è§‚ä¸­è§†é¢‘åŠ¿æ¯ 6 å°æ—¶æ›´æ–°ä¸€æ¬¡<br>
            å®è§‚ä¸­è¯äº‘æ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡<br>
            é£äº‘æ¦œï¼Œ24å°æ—¶æ›´æ–°ä¸€æ¬¡ <br>
            åå•æŸ¥æ¼è¡¥ç¼º: <a href="https://submit.vtbs.moe" target="_blank" rel="noopener noreferrer">https://submit.vtbs.moe</a><br>
            æˆ–è€…é‚®ä»¶: simon3000@163.com
            <br>
            æ€¥ä¸Šå‡çš„æ•°æ®æ˜¯è¿‡å»24å°æ—¶ç²‰ä¸æ•°å˜åŒ–ï¼Œå¹¶ä¸æ˜¯æ˜¨å¤©ä¸€å¤©çš„å˜åŒ–
          </p>
          <hr>
          <a href="https://github.com/dd-center/vtbs.moe/" target="_blank" rel="noopener noreferrer"><img alt="GitHub stars" src="https://img.shields.io/github/stars/dd-center/vtbs.moe.svg?style=social"></a> <br>
          <a href="https://github.com/dd-center/vtbs.moe/" target="_blank" rel="noopener noreferrer">github:dd-center/vtbs.moe</a>
          <br>
          <br>
          <!-- å…¶ä»–æœ‰è¶£çš„é¡¹ç›®: <a href="https://dd-center.github.io">dd-center.github.io</a> -->
          <!-- <br><br> -->
          <a class="button is-rounded" @click="push('â†’_â†’ï¼')">æµ‹è¯•Local Notification</a>
          <br>
          <hr>
          <h4 class="title is-4">è®¾ç½® (åˆ·æ–°ç½‘é¡µç”Ÿæ•ˆ)</h4>
          <h5 class="title is-5">å¼¹å¹•</h5>
          <label class="checkbox">
            <input type="checkbox" v-model="hideDanmaku">
            éšè—ç½‘é¡µå¼¹å¹•
          </label>
          <hr>
          <h5 class="title is-5">CDNç½‘ç»œ({{wss.length}})</h5>
          <p>ç›®å‰: <span class="has-background-light">{{currentWs}}</span></p>
          <br>
          <div v-for="ws in wss" :key="ws">
            <span class="tag">{{ws === currentWs ? 'å½“å‰' : 'å¯ç”¨'}}</span>{{ws}}
            <a class="button is-small is-rounded" @click="chooseWs(ws)" v-if="ws !== currentWs">é€‰æ‹©</a>
            <a class="button is-small is-rounded" @click="pingWs(ws)" v-if="!pingResult[ws]">Ping</a>
            <p v-if="pingResult[ws]">{{pingResult[ws]}}</p>
            <br>
            <br>
          </div>
          <hr>
           <p>å‹æƒ…é“¾æ¥ <a href="https://xuehusang.cn/ " target="_blank">é›ªç‹å†°å±‹</a></p>
        </div>
        <div class="column">
          <h3 class="title">api.vtbs.moe</h3>
          <a href="https://github.com/dd-center/vtbs.moe#open-api" target="_blank" rel="noopener noreferrer">Open API Documents</a>
          <br>
          <br>
          <h4 class="title is-4">æœåŠ¡å™¨æ•°æ®ï¼š</h4>
          <div v-if="interval && upMoment && number">
            <p>Spiders: {{spiders}}</p>
            <p v-loading="!interval">Interval: {{interval}} ms</p>
            <p v-loading="!upMoment">Uptime: {{upMoment}}</p>
            <p v-loading="!number">å…±æ”¶å½•VTB/VUP: {{number}} ä¸ª</p>
          </div>
          <progress v-else class="progress is-small" max="100"></progress>
          <p v-if="online">ç›®å‰åœ¨çº¿: {{online}}</p>
          <br>
          <div class="columns">
            <div class="column">
              <h5 class="title is-5">Spider: <small>({{spiderLeft}}/{{number}})</small></h5>
              <progress class="progress" max="100" :value="spiderProgress" :class="{'is-success': spiderProgress === 100}"></progress>
              <p>ä¸Šæ¬¡æ›´æ–°: {{spiderTime | parseTime}} <br>
                ç›®å‰è´Ÿè½½: {{spiderDuration | load(interval)}}</p>
            </div>
          </div>
          <br>
          <hr>
          <h1 class="title is-4">logs:</h1>
          <p v-for="(log) in [...logs].reverse()" :key="log.key">
            {{log.data}}
          </p>
        </div>
      </div>
    </div>
  </div>
</section>
</template>

<script>
import { mapState } from 'vuex'
import moment from 'moment'
import { get, socket, ws, ping, saveWsCDN } from '@/socket'
import Push from 'push.js'

export default {
  data() {
    this.currentWs = `https://${socket.io.engine.hostname}`
    this.wss = ws
    return {
      uptime: undefined,
      pingResult: {},
      hideDanmaku: !!localStorage.disableDanmaku,
    }
  },
  computed: {
    ...mapState(['logs', 'status', 'currentVtbs', 'online', 'spiderLeft', 'spiderDuration', 'spiderTime']),
    spiders: function() {
      return this.status.PARALLEL
    },
    interval: function() {
      return this.status.INTERVAL
    },
    number: function() {
      /* beautify ignore:start */
      return this.currentVtbs?.length
      /* beautify ignore:end */
    },
    spiderProgress() {
      return 100 - Math.round(this.spiderLeft / (this.number || 1) * 100)
    },
    upMoment() {
      if (this.uptime) {
        const duration = moment.duration(this.uptime, 's')
        const result = []
        const d = Math.floor(duration.asDays())
        const h = duration.hours()
        const m = duration.minutes()
        const s = duration.seconds()
        if (d) {
          result.push(`${d} å¤©`)
        }
        if (h) {
          result.push(`${h} æ—¶`)
        }
        if (m) {
          result.push(`${m} åˆ†`)
        }
        if (s) {
          result.push(`${s} ç§’`)
        }
        return result.join(' ')
      } else {
        return undefined
      }
    },
  },
  async mounted() {
    this.uptime = await get('uptime')
  },
  watch: {
    hideDanmaku() {
      if (this.hideDanmaku) {
        localStorage.disableDanmaku = 'true'
      } else {
        localStorage.removeItem('disableDanmaku')
      }
    },
  },
  methods: {
    push: w => Push.create(w),
    chooseWs(ws) {
      saveWsCDN(ws)
    },
    async pingWs(ws) {
      this.pingResult = { ...this.pingResult, [ws]: 'Ping...' }
      const result = await ping(ws)
      this.pingResult = { ...this.pingResult, [ws]: result }
    },
  },
  filters: {
    parseTime: function(time = 0) {
      const timeNow = moment(time)
      return `${timeNow.hours()}:${timeNow.minute()}`
    },
    load: function(duration, interval) {
      return `${Math.round(duration / interval * 1000) / 10}%`
    },
  },
}
</script>
